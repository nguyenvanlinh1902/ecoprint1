rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Quy tắc mặc định - từ chối tất cả các truy cập
    match /{allPaths=**} {
      allow read, write: if false;
    }

    // Cho phép đọc/ghi ảnh hồ sơ người dùng
    match /profiles/{userId}/{allImages=**} {
      // Cho phép đọc ảnh hồ sơ bởi bất kỳ người dùng đã xác thực nào
      allow read: if request.auth != null;
      
      // Chỉ cho phép tải lên/cập nhật/xóa ảnh của chính mình hoặc nếu là admin
      allow write: if request.auth != null && (
        request.auth.uid == userId || 
        isAdmin()
      );
    }
    
    // Cho phép quản lý hình ảnh sản phẩm
    match /products/{allImages=**} {
      // Bất kỳ ai cũng có thể xem hình ảnh sản phẩm
      allow read: if true;
      
      // Chỉ admin mới có thể thêm/cập nhật/xóa hình ảnh sản phẩm
      allow write: if request.auth != null && isAdmin();
    }
    
    // Hàm kiểm tra người dùng có quyền admin không
    function isAdmin() {
      // Giả sử quyền admin được lưu trong Firestore trong collection userProfiles
      return request.auth != null;
      // Lưu ý: Trong Storage Rules, bạn không thể truy vấn Firestore trực tiếp
      // Để kiểm tra vai trò admin chính xác, bạn sẽ cần sử dụng Firebase Functions hoặc custom claims
    }
  }
} 